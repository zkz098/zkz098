let NOWPLAYING=null;const isMobile=/mobile/i.test(window.navigator.userAgent),mediaPlayer=function(e,t){const n={el:{},create:function(){e.player.options.btns&&e.player.options.btns.forEach((function(t){n.el[t]||(n.el[t]=e.createChild("div",{className:t+" btn",onclick:function(n){e.player.fetch().then((function(){e.player.options.events[t](n)}))}}))}))}},a={el:null,btns:{mode:void 0,volume:void 0},step:"next",create:()=>{if(!e.player.options.controls)return;const t=a;e.player.options.controls.forEach((function(n){if(t.btns[n])return;const a={onclick:function(a){t.events[n]?t.events[n](a):e.player.options.events[n](a)}};switch(n){case"volume":a.className=" "+(o.muted?"off":"on"),a.innerHTML='<div class="bar"></div>',a["on"+d.nameMap.dragStart]=t.events.volume,a.onclick=null;break;case"mode":a.className=" "+e.player.options.mode;break;default:a.className=""}a.className=n+a.className+" btn",t.btns[n]=t.el.createChild("div",a)})),t.btns.volume.bar=t.btns.volume.child(".bar")},events:{mode:function(t){switch(e.player.options.mode){case"loop":e.player.options.mode="random";break;case"random":e.player.options.mode="order";break;default:e.player.options.mode="loop"}a.btns.mode.className="mode "+e.player.options.mode+" btn",$storage.set("_PlayerMode",e.player.options.mode)},volume:function(t){t.preventDefault();const n=t.currentTarget;let i=!1;const r=function(t){t.preventDefault(),e.player.volume(a.percent(t,n)),i=!0},s=function(t){t.preventDefault(),n.removeEventListener(d.nameMap.dragEnd,s),n.removeEventListener(d.nameMap.dragMove,r),i?(e.player.muted(),e.player.volume(a.percent(t,n))):o.muted?(e.player.muted(),e.player.volume(o.volume)):(e.player.muted("muted"),a.update(0))};n.addEventListener(d.nameMap.dragMove,r),n.addEventListener(d.nameMap.dragEnd,s)},backward:function(t){a.step="prev",e.player.mode()},forward:function(t){a.step="next",e.player.mode()}},update:function(e){a.btns.volume.className="volume "+(!o.muted&&e>0?"on":"off")+" btn",a.btns.volume.bar.width(Math.floor(100*e)+"%")},percent:function(e,t){let n=((e.clientX||e.changedTouches[0].clientX)-t.left())/t.width();return n=Math.max(n,0),Math.min(n,1)}},i={el:null,bar:null,create:function(){const e=s.current().el;e&&(i.el&&(i.el.parentNode.removeClass("current").removeEventListener(d.nameMap.dragStart,i.drag),i.el.remove()),i.el=e.createChild("div",{className:"progress"}),i.el.attr("data-dtime",d.secondToTime(0)),i.bar=i.el.createChild("div",{className:"bar"}),e.addClass("current"),e.addEventListener(d.nameMap.dragStart,i.drag),s.scroll())},update:function(e){i.bar.width(Math.floor(100*e)+"%"),i.el.attr("data-ptime",d.secondToTime(e*o.duration))},seeking:function(e){e?i.el.addClass("seeking"):i.el.removeClass("seeking")},percent:function(e,t){let n=((e.clientX||e.changedTouches[0].clientX)-t.left())/t.width();return n=Math.max(n,0),Math.min(n,1)},drag:function(t){t.preventDefault();const n=s.current().el,a=function(e){e.preventDefault();const t=i.percent(e,n);i.update(t),u.update(t*o.duration)},r=function(t){t.preventDefault(),n.removeEventListener(d.nameMap.dragEnd,r),n.removeEventListener(d.nameMap.dragMove,a);const s=i.percent(t,n);i.update(s),e.player.seek(s*o.duration),o.disableTimeupdate=!1,i.seeking(!1)};o.disableTimeupdate=!0,i.seeking(!0),n.addEventListener(d.nameMap.dragMove,a),n.addEventListener(d.nameMap.dragEnd,r)}},r={el:null,create:function(){const t=s.current();r.el.innerHTML='<div class="cover"><div class="disc"><img src="'+t.cover+'" class="blur"  alt="music cover"/></div></div><div class="info"><h4 class="title">'+t.name+"</h4><span>"+t.artist+'</span><div class="lrc"></div></div>',r.el.child(".cover").addEventListener("click",e.player.options.events["play-pause"]),u.create(r.el.child(".lrc"))}};let o;const s={el:null,data:[],index:-1,errnum:0,add:(e,t)=>{t.forEach((function(t,n){t.group=e,t.name=t.name||t.title||"Meida name",t.artist=t.artist||t.author||"Anonymous",t.cover=t.cover||t.pic,t.type=t.type||"normal",s.data.push(t)}))},clear:function(){s.data=[],s.el.innerHTML="",-1!==s.index&&(s.index=-1,e.player.fetch())},create:function(){const t=s.el;s.data.map((function(n,a){if(n.el)return;const r="list-"+e.player._id+"-"+n.group;let l=$dom("#"+r);return l||(l=t.createChild("div",{id:r,className:e.player.group?"tab":"",innerHTML:"<ol></ol>"}),e.player.group&&l.attr("data-title",e.player.options.rawList[n.group].title).attr("data-id",e.player._id)),n.el=l.child("ol").createChild("li",{title:n.name+" - "+n.artist,innerHTML:'<span class="info"><span>'+n.name+"</span><span>"+n.artist+"</span></span>",onclick:function(t){const n=t.currentTarget;s.index===a&&i.el?o.paused?e.player.play():e.player.seek(o.duration*i.percent(t,n)):(e.player.switch(a),e.player.play())}}),n})),tabFormat()},current:function(){return this.data[this.index]},scroll:function(){const e=this.current();let t=this.el.child("li.active");t&&t.removeClass("active");let n=this.el.child(".tab.active");return n&&n.removeClass("active"),t=this.el.find(".nav li")[e.group],t&&t.addClass("active"),n=this.el.find(".tab")[e.group],n&&n.addClass("active"),pageScroll(e.el,e.el.offsetTop),this},title:function(){if(o.paused)return;const e=this.current();document.title="Now Playing..."+e.name+" - "+e.artist+" | "+originTitle},error:function(){const e=this.current();e.el.removeClass("current").addClass("error"),e.error=!0,this.errnum++}},l={el:null,create:function(){this.el||(this.el=e.createChild("div",{className:"player-info",innerHTML:("audio"===e.player.options.type?'<div class="preview"></div>':"")+'<div class="controller"></div><div class="playlist"></div>'},"after"),r.el=this.el.child(".preview"),s.el=this.el.child(".playlist"),a.el=this.el.child(".controller"))},hide:function(){const e=this.el;e.addClass("hide"),window.setTimeout((function(){e.removeClass("show hide")}),300)}};let c={type:"audio",mode:"random",btns:["play-pause","music"],controls:["mode","backward","play-pause","forward","volume"],events:{"play-pause":function(t){o.paused?e.player.play():e.player.pause()},music:function(e){l.el.hasClass("show")?l.hide():(l.el.addClass("show"),s.scroll().title())}}},d={random:function(e){return Math.floor(Math.random()*e)},parse:function(e){let t=[];return[["music.163.com.*song.*id=(\\d+)","netease","song"],["music.163.com.*album.*id=(\\d+)","netease","album"],["music.163.com.*artist.*id=(\\d+)","netease","artist"],["music.163.com.*playlist.*id=(\\d+)","netease","playlist"],["music.163.com.*discover/toplist.*id=(\\d+)","netease","playlist"],["y.qq.com.*song/(\\w+).html","tencent","song"],["y.qq.com.*album/(\\w+).html","tencent","album"],["y.qq.com.*singer/(\\w+).html","tencent","artist"],["y.qq.com.*playsquare/(\\w+).html","tencent","playlist"],["y.qq.com.*playlist/(\\w+).html","tencent","playlist"],["xiami.com.*song/(\\w+)","xiami","song"],["xiami.com.*album/(\\w+)","xiami","album"],["xiami.com.*artist/(\\w+)","xiami","artist"],["xiami.com.*collect/(\\w+)","xiami","playlist"]].forEach((function(n){const a=new RegExp(n[0]).exec(e);null!==a&&(t=[n[1],n[2],a[1]])})),t},fetch:function(e){const t=[];return new Promise((function(n,a){e.forEach((function(e){const a=d.parse(e);if(a[0]){const e=JSON.stringify(a),i=$storage.get(e);i?(t.push(...JSON.parse(i)),n(t)):fetch("https://api.i-meto.com/meting/api?server="+a[0]+"&type="+a[1]+"&id="+a[2]+"&r="+Math.random()).then((function(e){return e.json()})).then((function(a){$storage.set(e,JSON.stringify(a)),t.push(...a),n(t)})).catch((e=>{}))}else t.push(e),n(t)}))}))},secondToTime:function(e){const t=Math.floor(e/3600),n=Math.floor((e-3600*t)/60),a=Math.floor(e-3600*t-60*n);return(t>0?[t,n,a]:[n,a]).map((function(e){return isNaN(e)?"00":e<10?"0"+e:""+e})).join(":")},nameMap:{dragStart:isMobile?"touchstart":"mousedown",dragMove:isMobile?"touchmove":"mousemove",dragEnd:isMobile?"touchend":"mouseup"}};o=null,e.player={_id:d.random(999999),group:!0,load:function(e){let t="";e&&e.length>0?this.options.rawList!==e&&(this.options.rawList=e,s.clear()):(t="none",this.pause());for(const e in n.el)n.el[e].display(t);return this},fetch:function(){const e=this;return new Promise((function(t,n){if(s.data.length>0)t(!0);else if(e.options.rawList){const n=[];e.options.rawList.forEach((function(t,a){n.push(new Promise((function(n,i){let r,o=a;t.list?(e.group=!0,r=t.list):(o=0,e.group=!1,r=[t]),d.fetch(r).then((function(e){s.add(o,e),n(0)}))})))})),Promise.all(n).then((function(){t(!0)}))}})).then((function(t){t&&(s.create(),a.create(),e.mode())}))},mode:function(){const e=s.data.length;if(!e||s.errnum===e)return;const t="next"===a.step?1:-1,n=function(){let n=s.index+t;(n>e||n<0)&&(n="next"===a.step?0:e-1),s.index=n},i=function(){const t=d.random(e);s.index!==t?s.index=t:n()};switch(this.options.mode){case"random":i();break;case"order":n();break;case"loop":a.step&&n(),-1===s.index&&i()}this.init()},switch:function(e){"number"==typeof e&&e!==s.index&&s.current()&&!s.current().error&&(s.index=e,this.init())},init:function(){const e=s.current();if(!e||e.error)return void this.mode();let t=!1;o.paused||(t=!0,this.stop()),o.attr("src",e.url),o.attr("title",e.name+" - "+e.artist),this.volume($storage.get("_PlayerVolume")||"0.7"),this.muted($storage.get("_PlayerMuted")),i.create(),"audio"===this.options.type&&r.create(),!0===t&&this.play()},play:function(){NOWPLAYING&&NOWPLAYING.player.pause(),s.current().error?this.mode():o.play().then((function(){s.scroll()})).catch((function(e){}))},pause:function(){o.pause(),document.title=originTitle},stop:function(){o.pause(),o.currentTime=0,document.title=originTitle},seek:function(e){e=Math.max(e,0),e=Math.min(e,o.duration),o.currentTime=e,i.update(e/o.duration)},muted:function(e){"muted"===e?(o.muted=e,$storage.set("_PlayerMuted",e),a.update(0)):($storage.del("_PlayerMuted"),o.muted=!1,a.update(o.volume))},volume:function(e){isNaN(e)||(a.update(e),$storage.set("_PlayerVolume",e),o.volume=e)},mini:function(){l.hide()}};const u={el:null,data:null,index:0,create:e=>{const t=s.index,n=s.current().lrc,a=function(n){if(t!==s.index)return;this.data=this.parse(n);let a="";this.data.forEach((function(e,t){a+="<p"+(0===t?' class="current"':"")+">"+e[1]+"</p>"})),this.el=e.createChild("div",{className:"inner",innerHTML:a},"replace"),this.index=0};n.startsWith("http")?this.fetch(n,a):a(n)},update:function(e){if(this.data&&(this.index>this.data.length-1||e<this.data[this.index][0]||!this.data[this.index+1]||e>=this.data[this.index+1][0]))for(let t=0;t<this.data.length;t++)if(e>=this.data[t][0]&&(!this.data[t+1]||e<this.data[t+1][0])){this.index=t;const e=-(this.index-1);this.el.style.transform="translateY("+e+"rem)",this.el.getElementsByClassName("current")[0].removeClass("current"),this.el.getElementsByTagName("p")[t].addClass("current")}},parse:function(e){if(e){const t=(e=e.replace(/([^\]^\n])\[/g,(function(e,t){return t+"\n["}))).split("\n");let n=[];const a=t.length;for(let e=0;e<a;e++){const a=t[e].match(/\[(\d{2}):(\d{2})(\.(\d{2,3}))?]/g),i=t[e].replace(/.*\[(\d{2}):(\d{2})(\.(\d{2,3}))?]/g,"").replace(/<(\d{2}):(\d{2})(\.(\d{2,3}))?>/g,"").replace(/^\s+|\s+$/g,"");if(a){const e=a.length;for(let t=0;t<e;t++){const e=/\[(\d{2}):(\d{2})(\.(\d{2,3}))?]/.exec(a[t]),r=60*e[1]+parseInt(e[2])+(e[4]?parseInt(e[4])/(2===(e[4]+"").length?100:1e3):0);n.push([r,i])}}}return n=n.filter((function(e){return e[1]})),n.sort((function(e,t){return e[0]-t[0]})),n}return[]},fetch:function(e,t){fetch(e).then((function(e){return e.text()})).then((function(e){t(e)})).catch((function(e){}))}},p={onerror:function(){s.error(),e.player.mode()},ondurationchange:function(){1!==o.duration&&i.el.attr("data-dtime",d.secondToTime(o.duration))},onloadedmetadata:function(){e.player.seek(0),i.el.attr("data-dtime",d.secondToTime(o.duration))},onplay:function(){e.parentNode.addClass("playing"),showtip(p.attr("title")),NOWPLAYING=e},onpause:function(){e.parentNode.removeClass("playing"),NOWPLAYING=null},ontimeupdate:function(){this.disableTimeupdate||(i.update(this.currentTime/this.duration),u.update(this.currentTime))},onended:function(t){e.player.mode(),e.player.play()}};return function(t){e.player.created||(e.player.options=Object.assign(c,t),e.player.options.mode=$storage.get("_PlayerMode")||e.player.options.mode,n.create(),o=e.createChild(e.player.options.type,p),l.create(),e.parentNode.addClass(e.player.options.type),e.player.created=!0)}(t),e};