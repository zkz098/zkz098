let NOWPLAYING=null;const isMobile=/mobile/i.test(window.navigator.userAgent),mediaPlayer=function(r,e){const a={el:{},create:()=>{r.player.options.btns&&r.player.options.btns.forEach(function(t){this.el[t]||(this.el[t]=r.createChild("div",{className:t+" btn",onclick:function(e){r.player.fetch().then(function(){r.player.options.events[t](e)})}}))})}},o={el:null,btns:{mode:void 0,volume:void 0},step:"next",create:()=>{if(r.player.options.controls){const n=this;r.player.options.controls.forEach(function(t){if(!n.btns[t]){const e={onclick:function(e){(n.events[t]?n:r.player.options).events[t](e)}};switch(t){case"volume":e.className=" "+(l.muted?"off":"on"),e.innerHTML='<div class="bar"></div>',e["on"+d.nameMap.dragStart]=n.events.volume,e.onclick=null;break;case"mode":e.className=" "+r.player.options.mode;break;default:e.className=""}e.className=t+e.className+" btn",n.btns[t]=n.el.createChild("div",e)}}),n.btns.volume.bar=n.btns.volume.child(".bar")}},events:{mode:function(e){switch(r.player.options.mode){case"loop":r.player.options.mode="random";break;case"random":r.player.options.mode="order";break;default:r.player.options.mode="loop"}o.btns.mode.className="mode "+r.player.options.mode+" btn",$storage.set("_PlayerMode",r.player.options.mode)},volume:function(e){e.preventDefault();const t=e.currentTarget;let n=!1;const a=function(e){e.preventDefault(),r.player.volume(o.percent(e,t)),n=!0},i=function(e){e.preventDefault(),t.removeEventListener(d.nameMap.dragEnd,i),t.removeEventListener(d.nameMap.dragMove,a),n?(r.player.muted(),r.player.volume(o.percent(e,t))):l.muted?(r.player.muted(),r.player.volume(l.volume)):(r.player.muted("muted"),o.update(0))};t.addEventListener(d.nameMap.dragMove,a),t.addEventListener(d.nameMap.dragEnd,i)},backward:function(e){o.step="prev",r.player.mode()},forward:function(e){o.step="next",r.player.mode()}},update:function(e){o.btns.volume.className="volume "+(!l.muted&&0<e?"on":"off")+" btn",o.btns.volume.bar.width(Math.floor(100*e)+"%")},percent:function(e,t){e=((e.clientX||e.changedTouches[0].clientX)-t.left())/t.width(),e=Math.max(e,0);return Math.min(e,1)}},s={el:null,bar:null,create:function(){const e=c.current().el;e&&(this.el&&(this.el.parentNode.removeClass("current").removeEventListener(d.nameMap.dragStart,this.drag),this.el.remove()),this.el=e.createChild("div",{className:"progress"}),this.el.attr("data-dtime",d.secondToTime(0)),this.bar=this.el.createChild("div",{className:"bar"}),e.addClass("current"),e.addEventListener(d.nameMap.dragStart,this.drag),c.scroll())},update:function(e){this.bar.width(Math.floor(100*e)+"%"),this.el.attr("data-ptime",d.secondToTime(e*l.duration))},seeking:function(e){e?this.el.addClass("seeking"):this.el.removeClass("seeking")},percent:function(e,t){e=((e.clientX||e.changedTouches[0].clientX)-t.left())/t.width(),e=Math.max(e,0);return Math.min(e,1)},drag:function(e){e.preventDefault();const t=c.current().el,n=function(e){e.preventDefault();e=s.percent(e,t);s.update(e),u.update(e*l.duration)},a=function(e){e.preventDefault(),t.removeEventListener(d.nameMap.dragEnd,a),t.removeEventListener(d.nameMap.dragMove,n);e=s.percent(e,t);s.update(e),r.player.seek(e*l.duration),l.disableTimeupdate=!1,s.seeking(!1)};l.disableTimeupdate=!0,s.seeking(!0),t.addEventListener(d.nameMap.dragMove,n),t.addEventListener(d.nameMap.dragEnd,a)}},n={el:null,create:function(){var e=c.current();this.el.innerHTML='<div class="cover"><div class="disc"><img src="'+e.cover+'" class="blur" /></div></div><div class="info"><h4 class="title">'+e.name+"</h4><span>"+e.artist+'</span><div class="lrc"></div></div>',this.el.child(".cover").addEventListener("click",r.player.options.events["play-pause"]),u.create(this.el.child(".lrc"))}};let l;const c={el:null,data:[],index:-1,errnum:0,add:(n,e)=>{e.forEach(function(e,t){e.group=n,e.name=e.name||e.title||"Meida name",e.artist=e.artist||e.author||"Anonymous",e.cover=e.cover||e.pic,e.type=e.type||"normal",this.data.push(e)})},clear:function(){this.data=[],this.el.innerHTML="",-1!==this.index&&(this.index=-1,r.player.fetch())},create:function(){const i=this.el;this.data.map(function(t,n){if(!t.el){var a="list-"+r.player._id+"-"+t.group;let e=$dom("#"+a);return e||(e=i.createChild("div",{id:a,className:r.player.group?"tab":"",innerHTML:"<ol></ol>"}),r.player.group&&e.attr("data-title",r.player.options.rawList[t.group].title).attr("data-id",r.player._id)),t.el=e.child("ol").createChild("li",{title:t.name+" - "+t.artist,innerHTML:'<span class="info"><span>'+t.name+"</span><span>"+t.artist+"</span></span>",onclick:function(e){var t=e.currentTarget;c.index===n&&s.el?l.paused?r.player.play():r.player.seek(l.duration*s.percent(e,t)):(r.player.switch(n),r.player.play())}}),t}}),tabFormat()},current:function(){return this.data[this.index]},scroll:function(){var e=this.current();let t=this.el.child("li.active"),n=(t&&t.removeClass("active"),this.el.child(".tab.active"));return n&&n.removeClass("active"),(t=this.el.find(".nav li")[e.group])&&t.addClass("active"),(n=this.el.find(".tab")[e.group])&&n.addClass("active"),pageScroll(e.el,e.el.offsetTop),this},title:function(){var e;l.paused||(e=this.current(),document.title="Now Playing..."+e.name+" - "+e.artist+" | "+originTitle)},error:function(){const e=this.current();e.el.removeClass("current").addClass("error"),e.error=!0,this.errnum++}},t={el:null,create:function(){this.el||(this.el=r.createChild("div",{className:"player-info",innerHTML:("audio"===r.player.options.type?'<div class="preview"></div>':"")+'<div class="controller"></div><div class="playlist"></div>'},"after"),n.el=this.el.child(".preview"),c.el=this.el.child(".playlist"),o.el=this.el.child(".controller"))},hide:function(){const e=this.el;e.addClass("hide"),window.setTimeout(function(){e.removeClass("show hide")},300)}};let i={type:"audio",mode:"random",btns:["play-pause","music"],controls:["mode","backward","play-pause","forward","volume"],events:{"play-pause":function(e){l.paused?r.player.play():r.player.pause()},music:function(e){t.el.hasClass("show")?t.hide():(t.el.addClass("show"),c.scroll().title())}}},d={random:function(e){return Math.floor(Math.random()*e)},parse:function(a){let i=[];return[["music.163.com.*song.*id=(\\d+)","netease","song"],["music.163.com.*album.*id=(\\d+)","netease","album"],["music.163.com.*artist.*id=(\\d+)","netease","artist"],["music.163.com.*playlist.*id=(\\d+)","netease","playlist"],["music.163.com.*discover/toplist.*id=(\\d+)","netease","playlist"],["y.qq.com.*song/(\\w+).html","tencent","song"],["y.qq.com.*album/(\\w+).html","tencent","album"],["y.qq.com.*singer/(\\w+).html","tencent","artist"],["y.qq.com.*playsquare/(\\w+).html","tencent","playlist"],["y.qq.com.*playlist/(\\w+).html","tencent","playlist"],["xiami.com.*song/(\\w+)","xiami","song"],["xiami.com.*album/(\\w+)","xiami","album"],["xiami.com.*artist/(\\w+)","xiami","artist"],["xiami.com.*collect/(\\w+)","xiami","playlist"]].forEach(function(e){const t=new RegExp(e[0]);var n=t.exec(a);null!==n&&(i=[e[1],e[2],n[1]])}),i},fetch:function(t){const r=[];return new Promise(function(i,e){t.forEach(function(e){var t=d.parse(e);if(t[0]){const a=JSON.stringify(t);var n=$storage.get(a);n?(r.push(...JSON.parse(n)),i(r)):fetch("https://api.i-meto.com/meting/api?server="+t[0]+"&type="+t[1]+"&id="+t[2]+"&r="+Math.random()).then(function(e){return e.json()}).then(function(e){$storage.set(a,JSON.stringify(e)),r.push(...e),i(r)}).catch(e=>{})}else r.push(e),i(r)})})},secondToTime:function(e){const t=Math.floor(e/3600),n=Math.floor((e-3600*t)/60),a=Math.floor(e-3600*t-60*n);return(0<t?[t,n,a]:[n,a]).map(function(e){return isNaN(e)?"00":e<10?"0"+e:""+e}).join(":")},nameMap:{dragStart:isMobile?"touchstart":"mousedown",dragMove:isMobile?"touchmove":"mousemove",dragEnd:isMobile?"touchend":"mouseup"}};l=null,r.player={_id:d.random(999999),group:!0,load:function(e){let t="";e&&0<e.length?this.options.rawList!==e&&(this.options.rawList=e,c.clear()):(t="none",this.pause());for(const n in a.el)a.el[n].display(t);return this},fetch:function(){const s=this;return new Promise(function(e,t){if(0<c.data.length)e(!0);else if(s.options.rawList){const n=[];s.options.rawList.forEach(function(i,r){n.push(new Promise(function(t,e){let n=r,a;a=i.list?(s.group=!0,i.list):(n=0,s.group=!1,[i]),d.fetch(a).then(function(e){c.add(n,e),t(0)})}))}),Promise.all(n).then(function(){e(!0)})}}).then(function(e){e&&(c.create(),o.create(),s.mode())})},mode:function(){const t=c.data.length;if(t&&c.errnum!==t){const n="next"===o.step?1:-1,a=function(){let e=c.index+n;(e>t||e<0)&&(e="next"===o.step?0:t-1),c.index=e};function e(){var e=d.random(t);c.index!==e?c.index=e:a()}switch(this.options.mode){case"random":e();break;case"order":a();break;case"loop":o.step&&a(),-1===c.index&&e()}this.init()}},switch:function(e){"number"==typeof e&&e!==c.index&&c.current()&&!c.current().error&&(c.index=e,this.init())},init:function(){var t=c.current();if(!t||t.error)this.mode();else{let e=!1;l.paused||(e=!0,this.stop()),l.attr("src",t.url),l.attr("title",t.name+" - "+t.artist),this.volume($storage.get("_PlayerVolume")||"0.7"),this.muted($storage.get("_PlayerMuted")),s.create(),"audio"===this.options.type&&n.create(),!0===e&&this.play()}},play:function(){NOWPLAYING&&NOWPLAYING.player.pause(),c.current().error?this.mode():l.play().then(function(){c.scroll()}).catch(function(e){})},pause:function(){l.pause(),document.title=originTitle},stop:function(){l.pause(),l.currentTime=0,document.title=originTitle},seek:function(e){e=Math.max(e,0),e=Math.min(e,l.duration),l.currentTime=e,s.update(e/l.duration)},muted:function(e){"muted"===e?(l.muted=e,$storage.set("_PlayerMuted",e),o.update(0)):($storage.del("_PlayerMuted"),l.muted=!1,o.update(l.volume))},volume:function(e){isNaN(e)||(o.update(e),$storage.set("_PlayerVolume",e),l.volume=e)},mini:function(){t.hide()}};const u={el:null,data:null,index:0,create:t=>{const n=c.index,e=c.current().lrc;function a(e){if(n===c.index){this.data=this.parse(e);let n="";this.data.forEach(function(e,t){n+="<p"+(0===t?' class="current"':"")+">"+e[1]+"</p>"}),this.el=t.createChild("div",{className:"inner",innerHTML:n},"replace"),this.index=0}}e.startsWith("http")?this.fetch(e,a):a(e)},update:function(t){if(this.data&&(this.index>this.data.length-1||t<this.data[this.index][0]||!this.data[this.index+1]||t>=this.data[this.index+1][0]))for(let e=0;e<this.data.length;e++){var n;t>=this.data[e][0]&&(!this.data[e+1]||t<this.data[e+1][0])&&(this.index=e,n=-(this.index-1),this.el.style.transform="translateY("+n+"rem)",this.el.getElementsByClassName("current")[0].removeClass("current"),this.el.getElementsByTagName("p")[e].addClass("current"))}},parse:function(e){if(e){const c=(e=e.replace(/([^\]^\n])\[/g,function(e,t){return t+"\n["})).split("\n");let t=[];var n=c.length;for(let e=0;e<n;e++){var a=c[e].match(/\[(\d{2}):(\d{2})(\.(\d{2,3}))?]/g),i=c[e].replace(/.*\[(\d{2}):(\d{2})(\.(\d{2,3}))?]/g,"").replace(/<(\d{2}):(\d{2})(\.(\d{2,3}))?>/g,"").replace(/^\s+|\s+$/g,"");if(a){var r=a.length;for(let e=0;e<r;e++){var s=/\[(\d{2}):(\d{2})(\.(\d{2,3}))?]/.exec(a[e]),o=60*s[1],l=parseInt(s[2]),s=s[4]?parseInt(s[4])/(2===(s[4]+"").length?100:1e3):0;t.push([o+l+s,i])}}}return(t=t.filter(function(e){return e[1]})).sort(function(e,t){return e[0]-t[0]}),t}return[]},fetch:function(e,t){fetch(e).then(function(e){return e.text()}).then(function(e){t(e)}).catch(function(e){})}},p={onerror:function(){c.error(),r.player.mode()},ondurationchange:function(){1!==l.duration&&s.el.attr("data-dtime",d.secondToTime(l.duration))},onloadedmetadata:function(){r.player.seek(0),s.el.attr("data-dtime",d.secondToTime(l.duration))},onplay:function(){r.parentNode.addClass("playing"),showtip(this.attr("title")),NOWPLAYING=r},onpause:function(){r.parentNode.removeClass("playing"),NOWPLAYING=null},ontimeupdate:function(){this.disableTimeupdate||(s.update(this.currentTime/this.duration),u.update(this.currentTime))},onended:function(e){r.player.mode(),r.player.play()}};return r.player.created||(r.player.options=Object.assign(i,e),r.player.options.mode=$storage.get("_PlayerMode")||r.player.options.mode,a.create(),l=r.createChild(r.player.options.type,p),t.create(),r.parentNode.addClass(r.player.options.type),r.player.created=!0),r};