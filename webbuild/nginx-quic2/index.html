<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta http-equiv="X-UA-COMPATIBLE" content="IE=edge,chrome=1"><meta name="renderer" content="webkit"><link rel="icon" type="image/ico" sizes="32x32" href="/assets/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"><meta name="msvalidate.01" content="5734c8017d654945bef5830f3849397b"><meta name="yandex-verification" content="06391432e7c086ec"><meta name="baidu-site-verification" content="0VfwXuDyx5cjfm5q"><link rel="alternate" href="/rss.xml" title="望月阁" type="application/rss+xml"><link rel="alternate" href="/atom.xml" title="望月阁" type="application/atom+xml"><link rel="alternate" type="application/json" title="望月阁" href="https://www.kaitaku.xyz/feed.json"><link rel="preconnect" href="https://s4.zstatic.net"><link rel="preconnect" href="https://at.alicdn.com"><link rel="preconnect" href="https://cdn.kaitaku.xyz"><link rel="stylesheet" href="/css/app.css?v=0.4.11"><link rel="modulepreload" href="/js/chunk-3ANS2HLL.js"><link rel="modulepreload" href="/js/chunk-CCUGZ7FO.js"><link rel="modulepreload" href="/js/chunk-POUWWD3H.js"><link rel="modulepreload" href="/js/chunk-X3MBRASA.js"><link rel="modulepreload" href="/js/copy-tex-7KJ2K4A3.js"><link rel="modulepreload" href="/js/index.esm-QGCLEHLG.js"><link rel="modulepreload" href="/js/post-7PTKS2DY.js"><link rel="modulepreload" href="/js/quicklink-B4NJI35Z.js"><link rel="modulepreload" href="/js/search-4LEYIKIJ.js"><link rel="modulepreload" href="/js/siteInit.js"><script data-pjax="data-pjax" async="async">if ('serviceWorker' in navigator) {
   navigator.serviceWorker.register("/sw.js?time=1723466105131").then(async (reg) => {
           if (window.localStorage.getItem('install') !== 'true') {
               window.localStorage.setItem('install', 'true');
               setTimeout(() => {
                   window.location.reload()
               }, 500)
           }
       }).catch(err => {
       console.log(err)
   });
   }</script><link rel="manifest" href="/manifest.json"><link rel="preload" href="https://cdn.kaitaku.xyz/cover.webp" as="image" fetchpriority="high"><meta name="keywords" content="http/3,quic,nginx-quic,nginx,boringssl"><meta name="description" content="一个萌新的学习笔记"><link rel="canonical" href="https://www.kaitaku.xyz/webbuild/nginx-quic2/"><meta name="description" content="# nginx 与 HTTP/3 # 开始之前 这是本站第三篇关于 HTTP/3 (或者说 QUIC) 的文章，从 caddy 到 nginx-quic 再到现在的 nginx 1.25，它终于正式支持了 HTTP/3 协议。 当然，openssl 还不支持且 2024 年前完成 QUIC 支持希望渺茫，因此本文使用 boringssl  代替 openssl。 quictls  和 libres">
<meta property="og:type" content="article">
<meta property="og:title" content="使用nginx 1.25开启 HTTP/3 支持">
<meta property="og:url" content="https://www.kaitaku.xyz/webbuild/nginx-quic2/index.html">
<meta property="og:site_name" content="望月阁">
<meta property="og:description" content="# nginx 与 HTTP/3 # 开始之前 这是本站第三篇关于 HTTP/3 (或者说 QUIC) 的文章，从 caddy 到 nginx-quic 再到现在的 nginx 1.25，它终于正式支持了 HTTP/3 协议。 当然，openssl 还不支持且 2024 年前完成 QUIC 支持希望渺茫，因此本文使用 boringssl  代替 openssl。 quictls  和 libres">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://www.kaitaku.xyz/webbuild/nginx-quic2/controller.png">
<meta property="og:image" content="https://www.kaitaku.xyz/webbuild/nginx-quic2/keys.png">
<meta property="og:image" content="https://www.kaitaku.xyz/webbuild/nginx-quic2/firewall.png">
<meta property="og:image" content="https://www.kaitaku.xyz/webbuild/nginx-quic2/ipv6.png">
<meta property="og:image" content="https://www.kaitaku.xyz/webbuild/nginx-quic2/safe.png">
<meta property="article:published_time" content="2023-11-03T13:42:37.000Z">
<meta property="article:modified_time" content="2023-11-08T12:46:33.779Z">
<meta property="article:author" content="zkz098">
<meta property="article:tag" content="nginx">
<meta property="article:tag" content="quic">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://www.kaitaku.xyz/webbuild/nginx-quic2/controller.png">
<meta name="twitter:creator" content="@kaitaku64672214"><title>使用nginx 1.25开启 HTTP/3 支持</title><meta name="generator" content="Hexo 7.3.0"></head><body itemscope="" itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">使用nginx 1.25开启 HTTP/3 支持</h1><div class="meta"><span class="item" title="创建时间：2023-11-03 21:42:37"><span class="icon"><i class="ic i-calendar"></i></span><span class="text">发表于</span><time itemprop="dateCreated datePublished" datetime="2023-11-03T21:42:37+08:00">2023-11-03</time></span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i></span><span class="text">本文字数</span><span>6.4k</span><span class="text">字</span></span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i></span><span class="text">阅读时长</span><span>6 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span><span class="line"></span><span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">kaitaku's blog</a></li></ul><ul class="right" id="rightNav"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div class="pjax" id="imgs"><img src="https://cdn.kaitaku.xyz/cover.webp" loading="eager" decoding="async" fetchpriority="high" alt="望月阁"></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"></use><use xlink:href="#gentle-wave" x="48" y="3"></use><use xlink:href="#gentle-wave" x="48" y="5"></use><use xlink:href="#gentle-wave" x="48" y="7"></use></g></svg></div><main><div class="inner"><div class="pjax" id="main"><div class="article wrap"><div class="breadcrumb" itemlistelement="" itemscope="" itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i><span><a href="/">首页</a></span><i class="ic i-angle-right"></i><span class="current" itemprop="itemListElement" itemscope="itemscope" itemtype="https://schema.org/ListItem"><a href="/categories/webbuild/" itemprop="item" rel="index" title="分类于网站建设"><span itemprop="name">网站建设<meta itemprop="position" content="0"></span></a></span></div><article class="post block" itemscope="itemscope" itemtype="http://schema.org/Article" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.kaitaku.xyz/webbuild/nginx-quic2/"><span hidden="hidden" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="image" content="/assets/avatar.webp"><meta itemprop="name" content="zkz098"><meta itemprop="description" content="kaitaku, 一个萌新的学习笔记"></span><span hidden="hidden" itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="望月阁"></span><div class="body md" itemprop="articleBody"><h1 id="nginx-与-http3"><a class="anchor" href="#nginx-与-http3">#</a> nginx 与 HTTP/3</h1>
<h2 id="开始之前"><a class="anchor" href="#开始之前">#</a> 开始之前</h2>
<p>这是本站第三篇关于 HTTP/3 (或者说 QUIC) 的文章，从 caddy 到 nginx-quic 再到现在的 nginx 1.25，它终于正式支持了 HTTP/3 协议。</p>
<p>当然，openssl 还不支持且 2024 年前完成 QUIC 支持希望渺茫，因此本文使用 <code>boringssl</code>  代替 openssl。 <code>quictls</code>  和 <code>libressl</code>  同样可以完成此工作，未来可能会提供相关教程（挖坑）</p>
<p>本文带有一定的广告内容，如果无法接受，您可以点击左侧的目录跳过相关部分。</p>
<h2 id="为什么选择-http3"><a class="anchor" href="#为什么选择-http3">#</a> 为什么选择 HTTP/3</h2>
<p>这里有一个可能不太恰当的比喻:</p>
<p>一天中午，你选择到 HTTP 街用餐，在你面前有两家餐厅：HTTP/2 和 HTTP/3 餐厅。</p>
<p>第一天你选择了 HTTP/2 餐厅进入，你点了许多美食和一个三明治。HTTP/2 餐厅的后厨可以同时制作多道菜，因此你认为你很快就能吃到美食。然后 HTTP/2 餐厅的<br>
服务员告诉你：“三明治出了点问题，后厨没法上菜。” 然后就出现了一个问题，根据 HTTP/2 餐厅的规则，在这道菜上菜之前，后面的菜不能上菜，即使它已经被制作好了。<br>
你花了很多时间来和服务员沟通，以确定 “三明治是不是真的出问题了” 和 “下一道菜什么时候上”。但这个三明治阻塞住了整个队列，因此你只能等后厨花费一段时间来处理三明治问题。</p>
<p>第二天你选择了 HTTP/3 餐厅，在这里，你只需要扫描准备好的二维码，然后点菜，随后等待菜品即可。和昨天一样，三明治再次堵塞了队列，但是这次 HTTP/3 餐厅可以选择不按顺序上菜。<br>
后厨很快就准备好了其他菜品，因此你并没有等待多久，而且消息已经被发送到了你的手机上，你并不需要和服务员花费时间沟通。</p>
<p>在上述例子中，“三明治” 代表了一个传输失败的数据包，而 HTTP2 虽然可以进行多路复用 (即同时制作多道菜品)，但如果数据包出现问题，仍可能阻塞整个队列。并且 TCP 的握手流程相当繁琐，<br>
需要花费很多时间来解决重发问题。而 HTTP3 则可以选择先发送什么后发送什么，即使 “三明治” 出了问题，也不会导致队列被整体阻塞，而且 UDP 在此方面效率较高，至少比 HTTP2 餐厅的服务员们要高多了。</p>
<details class="info"><summary>一个更细致的解释</summary><div>
<p>这个比喻用一个生动的场景来解释了 HTTP/2 和 HTTP/3 之间的主要区别。HTTP/2 和 HTTP/3 都是基于 TCP 和 UDP 的协议，它们用于在网络上传输数据。HTTP/2 使用 TCP，而 HTTP/3 使用 UDP。TCP 和 UDP 的区别在于，TCP 是一种可靠的协议，它保证了数据包的有序和完整的到达，但是如果数据包丢失或损坏，它会导致传输的延迟和阻塞。UDP 是一种不可靠的协议，它不保证数据包的有序和完整的到达，但是它可以更快地传输数据，而且不会因为数据包的丢失或损坏而阻塞整个流。</p>
<p>因此，HTTP/2 餐厅的规则类似于 TCP 的机制，它要求所有的菜品按照点菜的顺序上桌，如果有任何一道菜出了问题，就会影响后面的菜品，即使它们已经准备好了。这就是所谓的<strong>头部阻塞</strong>，它会降低传输的效率和用户的体验。HTTP/3 餐厅的规则类似于 UDP 的机制，它允许菜品按照任意的顺序上桌，如果有任何一道菜出了问题，也不会影响其他的菜品，它们可以继续被送到客人的手中。这就是所谓的<strong>无头部阻塞</strong>，它会提高传输的效率和用户的体验。</p>
<p>这个比喻也展示了 HTTP/2 和 HTTP/3 的另一个区别，就是<strong>多路复用</strong>和<strong>多流</strong>的概念。多路复用是指在一个 TCP 连接上同时传输多个请求和响应，而多流是指在一个 UDP 连接上同时传输多个独立的数据流。HTTP/2 使用多路复用，而 HTTP/3 使用多流。多路复用和多流的区别在于，多路复用是在一个连接上共享资源，而多流是在一个连接上分配资源。多路复用的优点是可以减少连接的数量和开销，但是缺点是如果一个请求或响应出了问题，就会影响整个连接上的其他请求或响应。多流的优点是可以隔离不同的数据流，使它们互不干扰，但是缺点是需要更多的连接和开销。</p>
<p>因此，HTTP/2 餐厅的后厨类似于多路复用的机制，它可以同时制作多道菜，但是如果有一道菜出了问题，就会影响其他的菜。HTTP/3 餐厅的二维码类似于多流的机制，它可以同时传输多个数据流，但是如果有一个数据流出了问题，也不会影响其他的数据流。</p>
<p>注：可能存在问题，因为字数太多懒得看第二遍（逃</p>
</div></details>
<h2 id="使用nginx-quic"><a class="anchor" href="#使用nginx-quic">#</a> 使用 Nginx-quic</h2>
<h3 id="前提条件"><a class="anchor" href="#前提条件">#</a> 前提条件</h3>
<p>本教程需要一个基于 ubuntu 22.04 (可以更高) 的服务器，并需要宝塔面板。如果你还没有的话，AWS 的 EC2 就是一个好选择：<br>
现在注册<a target="_blank" rel="noopener" href="https://www.amazonaws.cn/?sc_channel=seo&amp;sc_campaign=blog921">亚马逊云科技</a>账户可以享受<a target="_blank" rel="noopener" href="https://aws.amazon.com/cn/free/"> 12 个月免费套餐</a>，其中包括 Amazon EC2 云服务器、S3 云储存、Cloudfront CDN 等多种热门产品。<br>
为节省时间，此处省略注册账号的过程，仅保留新建实例的过程:<br>
 首先在控制台点击启动实例:<br>
<img loading="lazy" data-src="controller.webp" alt=""><br>
 随后输入相关内容，实例选择 <code>t2.micro</code> ，系统选择 <code>ubuntu 22.04LTS</code> ，随后创建密钥对：<br>
<img loading="lazy" data-src="keys.webp" alt=""><br>
根据需求选择，一般建议使用 pem 格式，提前选择放行 HTTPS 端口，节省时间:<br>
<img loading="lazy" data-src="firewall.webp" alt=""><br>
 一切完成之后，启动实例，等待创建完成后使用 SSH 连接到终端即可。<br>
另外建议开启 IPV6，操作如下：<br>
进入此 EC2 对应的 VPC，选择 <code>编辑CIDR</code> ，随后添加新的 IPV6 CIDR 块，选择 <code>Amazon 提供的 IPv6 CIDR 块</code> ，随后返回。<br>
<img loading="lazy" data-src="ipv6.webp" alt=""><br>
进入此 EC2 对应的子网，右键 <code>编辑 IPV6 CIDR</code> ，添加即可。<br>
然后进入路由表，为 <code>::/0</code>  添加一条和 <code>0.0.0.0/0</code>  一致的路由。<br>
随后进入 <code>EC2 设置</code> ，联网 -&gt; 管理 IP 设置，分配新的 IPV6 地址。<br>
现在，这台 EC2 实例已经支持 IPV6 了。</p>
<p>下文均可在此 EC2 实例的 SSH 终端内进行。<br>
本文全程基于 root 权限进行。</p>
<h3 id="安装依赖"><a class="anchor" href="#安装依赖">#</a> 安装依赖</h3>
<p>在终端运行如下指令:</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token function">apt</span> <span class="token function">install</span> build-essential ca-certificates zlib1g-dev libpcre3 libpcre3-dev <span class="token function">tar</span> <span class="token function">unzip</span> libssl-dev <span class="token function">wget</span> <span class="token function">curl</span> <span class="token function">git</span> cmake ninja-build golang</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 需要启用源代码软件源 (deb-src)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">apt-get</span> build-dep nginx</pre></td></tr></tbody></table></figure><h3 id="编译ssl库"><a class="anchor" href="#编译ssl库">#</a> 编译 ssl 库</h3>
<h4 id="编译boringssl"><a class="anchor" href="#编译boringssl">#</a> 编译 boringssl</h4>
<div class="note info">
<p>下列指令需要 gcc 支持 C++14 或更高标准，建议升级为 gcc9 以上版本</p>
</div>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token function">git</span> clone <span class="token parameter variable">--depth</span><span class="token operator">=</span><span class="token number">1</span> https://github.com/google/boringssl.git </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># github 速度问题自行解决</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token builtin class-name">cd</span> boringssl</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token function">mkdir</span> build</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token builtin class-name">cd</span> build</pre></td></tr><tr><td data-num="6"></td><td><pre>cmake <span class="token parameter variable">-GNinja</span> <span class="token punctuation">..</span></pre></td></tr><tr><td data-num="7"></td><td><pre>ninja</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>/<span class="token punctuation">..</span></pre></td></tr></tbody></table></figure><p>如果出现了网络问题，执行如下命令:</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre>go <span class="token function">env</span> <span class="token parameter variable">-w</span> <span class="token assign-left variable">GOPROXY</span><span class="token operator">=</span>https://goproxy.cn,direct</pre></td></tr></tbody></table></figure><h3 id="安装nginx-brotli可选"><a class="anchor" href="#安装nginx-brotli可选">#</a> 安装 nginx-brotli (可选)</h3>
<p>brotli 是一种由 google 提供的新型压缩方式，比传统的 gzip 在体积方面要小很多<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup> <br>
安装步骤如下，为保证路径合理，在 <code>/www/server</code>  下进行:</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token builtin class-name">cd</span> /www/server</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">git</span> clone https://github.com/google/ngx_brotli.git</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token builtin class-name">cd</span> ngx_brotli</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># vim .gitmodules</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># git submodule sync</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token function">git</span> submodule update <span class="token parameter variable">--init</span></pre></td></tr></tbody></table></figure><p>如果 clone 时使用了 github 加速，请解除第 4 行注释并修改此文件内的 url 为加速后链接，随后执行第 5 行后再进行下一步。</p>
<h3 id="获取和配置-nginx"><a class="anchor" href="#获取和配置-nginx">#</a> 获取和配置 nginx</h3>
<p>截止本文写就时，Nginx 最新版为 1.25.3，因此下列链接使用此版本:</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token function">wget</span> https://nginx.org/download/nginx-1.25.3.tar.gz</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">tar</span> <span class="token parameter variable">-xzvf</span> nginx-1.25.3.tar.gz</pre></td></tr></tbody></table></figure><p>随后运行:</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre>nginx <span class="token parameter variable">-V</span></pre></td></tr></tbody></table></figure><p>输出内容应该类似于:</p>
<figure class="highlight text"><figcaption data-lang="text"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre>nginx version: nginx/1.25.3</pre></td></tr><tr><td data-num="2"></td><td><pre>built by gcc 11.4.0 (Ubuntu 11.4.0-1ubuntu1~22.04) </pre></td></tr><tr><td data-num="3"></td><td><pre>built with OpenSSL 1.1.1q</pre></td></tr><tr><td data-num="4"></td><td><pre>TLS SNI support enabled</pre></td></tr><tr><td data-num="5"></td><td><pre>configure arguments: --user=www --group=www --prefix=/www/server/nginx --add-module=/www/server/nginx/src/ngx_devel_kit --add-module=/www/server/nginx/src/lua_nginx_module --add-module=/www/server/nginx/src/ngx_cache_purge --with-pcre=pcre-8.43 --with-http_v2_module --with-stream --with-stream_ssl_module --with-stream_ssl_preread_module --with-http_stub_status_module --with-http_ssl_module --with-http_image_filter_module --with-http_gzip_static_module --with-http_gunzip_module --with-ipv6 --with-http_sub_module --with-http_flv_module --with-http_addition_module --with-http_realip_module --with-http_mp4_module --add-module=/www/server/nginx/src/ngx_http_substitutions_filter_module-master --with-ld-opt=-Wl,-E --with-cc-opt=-Wno-error --with-ld-opt=-ljemalloc --with-http_dav_module --add-module=/www/server/nginx/src/nginx-dav-ext-module --with-openssl=/www/server/nginx/src/openssl</pre></td></tr></tbody></table></figure><p>此时，删除 <code>--with-openssl=...</code> ，并添加 <code>--with-http_v3_module</code>  和 <code>--with-cc-opt=-I../boringssl/include --with-ld-opt='-L../boringssl/build/ssl -L../boringssl/build/crypto'</code> <br>
 修改 <code>--with-pcre=pcre-8.43</code>  为 <code>--with-pcre=/www/server/nginx/src/pcre-8.43</code></p>
<div class="note warning">
<p>注意 boringssl 路径，编译参数和 <code>nginx-quic</code>  有不同，请勿直接沿用</p>
</div>
<p>如果你在上文中配置了 brotli，再添加 <code>--add-module=/www/server/ngx_brotli</code>  在尾部 <br>
现版本 OSCP 装订已可正常使用，无需注释相关配置</p>
<h3 id="编译-nginx"><a class="anchor" href="#编译-nginx">#</a> 编译 nginx</h3>
<div class="note info">
<p>部分环境编译时可能出现警告，如果出现了建议检查 Boringssl 路径和依赖。 <br>
均确认无误请修改 <code>objs/Makefile</code>  中的第三行，删除 <code>-Werror</code>  参数</p>
</div>
<p>在 <code>nginx</code>  对应目录下运行如下指令:</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre>./configure <span class="token comment"># 使用你的编译参数替换这段 (包括 #号)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">make</span></pre></td></tr></tbody></table></figure><p>如果成功结束则代表运行成功，此时可以替换 nginx 了</p>
<h3 id="替换-nginx"><a class="anchor" href="#替换-nginx">#</a> 替换 nginx</h3>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token function">mv</span> /www/server/nginx/sbin/nginx<span class="token punctuation">{</span>,.bak<span class="token punctuation">}</span> <span class="token comment"># 备份原本的 Nginx 文件</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">cp</span> objs/nginx /www/server/nginx/sbin</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">make</span> upgrade</pre></td></tr></tbody></table></figure><p>如果 <code>make upgrade</code>  未出现报错，则升级成功。</p>
<h2 id="配置-http3"><a class="anchor" href="#配置-http3">#</a> 配置 HTTP/3</h2>
<h3 id="配置服务器的udp-443端口"><a class="anchor" href="#配置服务器的udp-443端口">#</a> 配置服务器的 UDP 443 端口</h3>
<p>多数 ubuntu 系统使用 <code>ufw</code>  作为防火墙，运行下列指令放行:</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre>ufw allow <span class="token number">443</span>/udp</pre></td></tr></tbody></table></figure><p>或者使用宝塔系统防火墙放行，默认显示 <code>443</code>  为 <code>udp/tcp</code> ，实际上 <code>udp</code>  未放行，修改后保存即可</p>
<h3 id="修改安全组"><a class="anchor" href="#修改安全组">#</a> 修改安全组</h3>
<p>这里以 AWS 为例，需要在服务器安全组放行 UDP 443:<br>
 通过 EC2 下方的安全 -&gt; 安全组，然后添加入站规则:<br>
<img loading="lazy" data-src="safe.webp" alt=""><br>
 和图片一样添加 443 端口的 UDP 入站即可，IPV6 需要额外添加一条入站。<br>
现在服务器的 QUIC 已经可以正常运行了</p>
<h3 id="配置http3"><a class="anchor" href="#配置http3">#</a> 配置 HTTP/3</h3>
<div class="note warning">
<p>HTTP/3 需要 SSL 证书才能启用，若为本地或测试环境请自签证书</p>
</div>
<p>在宝塔中调整对应网站配置，在 <code>listen 443 ssl http2;</code>  后加入:</p>
<figure class="highlight nginx"><figcaption data-lang="nginx"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token directive"><span class="token keyword">listen</span> <span class="token number">443</span> quic reuseport</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token directive"><span class="token keyword">add_header</span> Alt-Svc <span class="token string">'h3=":443"; ma=86400'</span></span><span class="token punctuation">;</span></pre></td></tr></tbody></table></figure><p>随后开启 0-RTT 握手和 OSCP 装订:</p>
<figure class="highlight nginx"><figcaption data-lang="nginx"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token directive"><span class="token keyword">ssl_early_data</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token directive"><span class="token keyword">ssl_stapling</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token directive"><span class="token keyword">ssl_stapling_verify</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span></pre></td></tr></tbody></table></figure><div class="note danger">
<p><code>ssl_early_data</code>  开启了 QUIC 和 TLS 1.3 的 0-RTT 握手机制，如果网站涉及反代 (或动态网页)，请确保你的应用可以防御重放攻击<sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup>.</p>
</div>
<h3 id="测试"><a class="anchor" href="#测试">#</a> 测试</h3>
<p>使用 <code>firefox</code>  或者 <code>chrome</code>  (需调整 flags) 访问对应网页，开发者工具中如果可以看见协议为 <code>h3</code>  则成功。</p>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p><a target="_blank" rel="noopener" href="https://github.com/google/brotli">brotli github</a> <a href="#fnref1" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn2" class="footnote-item"><p><a target="_blank" rel="noopener" href="https://www.oschina.net/translate/rfc-8446-aka-tls-1-3?lang=chs&amp;p=3">详细介绍 RFC 8446（即 TLS 1.3）</a> <a href="#fnref2" class="footnote-backref">↩︎</a></p>
</li>
</ol>
</section>
<div class="tags"><a href="/tags/nginx/" rel="tag"><i class="ic i-tag"></i>nginx</a><a href="/tags/quic/" rel="tag"><i class="ic i-tag"></i>quic</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i></span><span class="text">更新于</span><time title="修改时间：2023-11-08 20:46:33" itemprop="dateModified" datetime="2023-11-08T20:46:33+08:00">2023-11-08</time></span></div><div id="copyright"><ul><li class="author"><strong>本文作者：</strong>zkz098<i class="ic i-at"><em>@</em></i>望月阁</li><li class="link"><strong>本文链接：</strong><a href="https://www.kaitaku.xyz/webbuild/nginx-quic2/" title="使用nginx 1.25开启 HTTP/3 支持">https://www.kaitaku.xyz/webbuild/nginx-quic2/</a></li><li class="license"><strong>版权声明：</strong>本站所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/webbuild/nginx-modsec/" rel="prev" itemprop="url" data-background-image="https://cdn.kaitaku.xyz/img6.webp" title="使用ModSecurity保护Nginx站点"><span class="type">上一篇</span><span class="category"><i class="ic i-flag"></i>网站建设</span><h3>使用ModSecurity保护Nginx站点</h3></a></div><div class="item right"><a href="/python/bert-vits2/" rel="next" itemprop="url" data-background-image="https://cdn.kaitaku.xyz/img4.webp" title="使用 bert-vits2 进行训练/推理的踩坑记录"><span class="type">下一篇</span><span class="category"><i class="ic i-flag"></i>python</span><h3>使用 bert-vits2 进行训练/推理的踩坑记录</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#nginx-%E4%B8%8E-http3"><span class="toc-number">1.</span> <span class="toc-text"> nginx 与 HTTP/3</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%80%E5%A7%8B%E4%B9%8B%E5%89%8D"><span class="toc-number">1.1.</span> <span class="toc-text"> 开始之前</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%80%89%E6%8B%A9-http3"><span class="toc-number">1.2.</span> <span class="toc-text"> 为什么选择 HTTP/3</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8nginx-quic"><span class="toc-number">1.3.</span> <span class="toc-text"> 使用 Nginx-quic</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E6%8F%90%E6%9D%A1%E4%BB%B6"><span class="toc-number">1.3.1.</span> <span class="toc-text"> 前提条件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96"><span class="toc-number">1.3.2.</span> <span class="toc-text"> 安装依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E8%AF%91ssl%E5%BA%93"><span class="toc-number">1.3.3.</span> <span class="toc-text"> 编译 ssl 库</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E8%AF%91boringssl"><span class="toc-number">1.3.3.1.</span> <span class="toc-text"> 编译 boringssl</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85nginx-brotli%E5%8F%AF%E9%80%89"><span class="toc-number">1.3.4.</span> <span class="toc-text"> 安装 nginx-brotli (可选)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%92%8C%E9%85%8D%E7%BD%AE-nginx"><span class="toc-number">1.3.5.</span> <span class="toc-text"> 获取和配置 nginx</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E8%AF%91-nginx"><span class="toc-number">1.3.6.</span> <span class="toc-text"> 编译 nginx</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%BF%E6%8D%A2-nginx"><span class="toc-number">1.3.7.</span> <span class="toc-text"> 替换 nginx</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-http3"><span class="toc-number">1.4.</span> <span class="toc-text"> 配置 HTTP/3</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84udp-443%E7%AB%AF%E5%8F%A3"><span class="toc-number">1.4.1.</span> <span class="toc-text"> 配置服务器的 UDP 443 端口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E5%AE%89%E5%85%A8%E7%BB%84"><span class="toc-number">1.4.2.</span> <span class="toc-text"> 修改安全组</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEhttp3"><span class="toc-number">1.4.3.</span> <span class="toc-text"> 配置 HTTP/3</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">1.4.4.</span> <span class="toc-text"> 测试</span></a></li></ol></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/webbuild/quic/" rel="bookmark" title="使用caddy2支持QUIC协议">使用caddy2支持QUIC协议</a></li><li><a href="/webbuild/shokatwikoo/" rel="bookmark" title="shoka主题-更换评论区为twikoo">shoka主题-更换评论区为twikoo</a></li><li><a href="/webbuild/shokapatch/" rel="bookmark" title="shoka主题-对shoka主题的小修小补">shoka主题-对shoka主题的小修小补</a></li><li><a href="/webbuild/nginx-quic/" rel="bookmark" title="使用nginx-quic开启HTTP/3协议支持">使用nginx-quic开启HTTP/3协议支持</a></li><li><a href="/webbuild/hexo/hexoweb1/" rel="bookmark" title="从0搭建hexo博客-环境搭建">从0搭建hexo博客-环境搭建</a></li><li><a href="/webbuild/hexo/hexoweb2/" rel="bookmark" title="从0搭建hexo博客-安装主题">从0搭建hexo博客-安装主题</a></li><li><a href="/webbuild/shokajsdelivr/" rel="bookmark" title="shoka主题速度优化-拆分jsdelivr">shoka主题速度优化-拆分jsdelivr</a></li><li><a href="/webbuild/hexo/indexnow/" rel="bookmark" title="hexo-indexnow插件使用教程">hexo-indexnow插件使用教程</a></li><li><a href="/webbuild/shokaX/" rel="bookmark" title="Hexo主题shokaX文档">Hexo主题shokaX文档</a></li><li><a href="/webbuild/shokaXFAQ/" rel="bookmark" title="ShokaX常见问题">ShokaX常见问题</a></li><li><a href="/webbuild/shokaXplugin/" rel="bookmark" title="shokaX主题插件文档">shokaX主题插件文档</a></li><li><a href="/webbuild/nginx-modsec/" rel="bookmark" title="使用ModSecurity保护Nginx站点">使用ModSecurity保护Nginx站点</a></li><li class="active"><a href="/webbuild/nginx-quic2/" rel="bookmark" title="使用nginx 1.25开启 HTTP/3 支持">使用nginx 1.25开启 HTTP/3 支持</a></li><li><a href="/webbuild/hexo/hexoesm/" rel="bookmark" title="论 ESM 和 esbuild 在 hexo 主题中的应用">论 ESM 和 esbuild 在 hexo 主题中的应用</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><img class="image" loading="lazy" decoding="async" itemprop="image" alt="zkz098" src="/assets/avatar.webp"><p class="name" itemprop="name">zkz098</p><div class="description" itemprop="description">一个萌新的学习笔记</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">39</span><span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">9</span><span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">16</span><span class="name">标签</span></a></div></nav><div class="social"><a target="_blank" rel="noopener" href="https://github.com/zkz098" class="item github" title="https://github.com/zkz098"><i class="ic i-github"></i></a><a href="mailto:zkz20081204@126.com" class="item email" title="mailto:zkz20081204@126.com"><i class="ic i-envelope"></i></a><a target="_blank" rel="noopener" href="https://stackoverflow.com/users/19941267/kaitaku" class="item stackoverflow" title="https://stackoverflow.com/users/19941267/kaitaku"><i class="ic i-stack-overflow"></i></a></div><div class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item dropdown"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a><ul class="submenu"><li class="item"><a href="/about/" rel="section"><i class="ic i-star"></i>关于本站</a></li><li class="item"><a href="/updata/" rel="section"><i class="ic i-cloud"></i>更新日志</a></li><li class="item"><a href="/admiration/" rel="section"><i class="ic i-coffee"></i>赞赏博主</a></li><li class="item"><a href="/privacy/" rel="section"><i class="ic i-list-alt"></i>隐私政策</a></li></ul></li><li class="item dropdown"><a href="#" onclick="return false;"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><a href="/statistics/" rel="section"><i class="ic i-clock"></i>统计</a></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>友链</a></li><li class="item"><a target="_blank" href="https://www.travellings.cn/go.html" rel="section noopener"><i class="ic i-paper-plane"></i>开往</a></li></div></div></div></div><ul id="quick"><li class="prev pjax"><a href="/python/bert-vits2/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/webbuild/nginx-modsec/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/python/" title="分类于python">python</a><i class="ic i-angle-right"></i><a href="/categories/python/easy/" title="分类于基础篇">基础篇</a></div><span><a href="/python/easy/pythone8/">python-面向对象和生成器、迭代器</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/webbuild/" title="分类于网站建设">网站建设</a></div><span><a href="/webbuild/nginx-modsec/">使用ModSecurity保护Nginx站点</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/python/" title="分类于python">python</a><i class="ic i-angle-right"></i><a href="/categories/python/easy/" title="分类于基础篇">基础篇</a></div><span><a href="/python/easy/pythone6/">python-函数与作用域</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/misc/" title="分类于杂项">杂项</a></div><span><a href="/misc/windbg/">记一次用windbg分析蓝屏原因</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/python/" title="分类于python">python</a><i class="ic i-angle-right"></i><a href="/categories/python/app/" title="分类于应用篇">应用篇</a></div><span><a href="/python/app/pythona1/">python-用企业微信机器人发天气预报</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/webbuild/" title="分类于网站建设">网站建设</a><i class="ic i-angle-right"></i><a href="/categories/webbuild/hexo/" title="分类于hexo">hexo</a></div><span><a href="/webbuild/hexo/hexoweb2/">从0搭建hexo博客-安装主题</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/python/" title="分类于python">python</a><i class="ic i-angle-right"></i><a href="/categories/python/easy/" title="分类于基础篇">基础篇</a></div><span><a href="/python/easy/pythone5p/">python-常用模块</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/webbuild/" title="分类于网站建设">网站建设</a><i class="ic i-angle-right"></i><a href="/categories/webbuild/shokaX/" title="分类于shokaX">shokaX</a></div><span><a href="/webbuild/shokaX/">Hexo主题shokaX文档</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/python/" title="分类于python">python</a><i class="ic i-angle-right"></i><a href="/categories/python/easy/" title="分类于基础篇">基础篇</a></div><span><a href="/python/easy/pythone9/">python-面向对象与异常捕获</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/golang/" title="分类于GO语言学习笔记">GO语言学习笔记</a></div><span><a href="/golang/go3/">go语言-运算符和分支结构</a></span></li></ul></div><div class="rpost pjax"><h2>最新评论</h2></div></div><div class="status"><div class="copyright">© 2021 -<span itemprop="copyrightYear">2024</span><span class="with-love"><i class="ic i-sakura rotate"></i></span><span class="author" itemprop="copyrightHolder">zkz098 @ kaitaku's blog</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i></span><span title="站点总字数">110k 字</span><span class="post-meta-divider"> | </span><span class="post-meta-item-icon"><i class="ic i-coffee"></i></span><span title="站点阅读时长">1:40</span></div><div class="powered-by">基于 <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> &amp; Theme.<a target="_blank" rel="noopener" href="https://github.com/theme-shoka-x/hexo-theme-shokaX/">ShokaX</a></div><br><span style="display:inline;height:20px;line-height:20px;margin: 0px 0px 0px 5px; color:var(--grey-5);"><a target="_blank" rel="noopener" href="https://beian.miit.gov.cn">津ICP备2022001375号</a><br><a target="_blank" href="https://beian.mps.gov.cn/#/query/webSearch?code=12011402001353"><img loading="lazy" decoding="async" data-src="/assets/beian.webp" style="max-width: 2em;display:inline;" width="20" height="20" alt="备案">津公网安备 12011402001353号</a></span></div></div></footer></div><script data-config="" type="text/javascript">var LOCAL = {
    ispost: true,
        path: `webbuild/nginx-quic2/`,
        favicon: {
        show: `（●´3｀●）やれやれだぜ`,
        hide: `(´Д｀)大変だ！`
    },
    search: {
        placeholder: "文章搜索",
        empty: "关于 「 ${query} 」，什么也没搜到",
        stats: "${time} ms 内找到 ${hits} 条结果"
    },
    copy_tex: false,
    katex: false,
    mermaid: false,
    audio: undefined,
    fancybox: true,
    nocopy: false,
    outime: true,
    template: `<div class="note warning"><p><span class="label warning">文章时效性提示</span><br>这是一篇发布于 {{publish}} 天前，最后一次更新在 {{updated}} 天前的文章，部分信息可能已经发生改变，请注意甄别。</p></div>`,
    quiz: {
        choice: `单选题`,
        multiple: `多选题`,
        true_false: `判断题`,
        essay: `问答题`,
        gap_fill: `填空题`,
        mistake: `错题备注`
    },
    ignores: [
        (uri) => uri.includes('#'),
        (uri) => new RegExp(LOCAL.path + '$').test(uri),
            []
    ]
};
</script><script>(function(c,l,a,r,i,t,y){
    c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
    t=l.createElement(r);t.async=true;t.src="https://www.clarity.ms/tag/"+i;
    y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
})(window, document, "clarity", "script", "acmqnsrk9g");</script><script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-JLLBM8ZTTD"></script><script data-pjax="data-pjax">window.dataLayer = window.dataLayer || [];
function gtag() {
    dataLayer.push(arguments);
}
gtag('js', new Date());
gtag('config', 'G-JLLBM8ZTTD');</script><script src="https://s4.zstatic.net/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha384-k6YtvFUEIuEFBdrLKJ3YAUbBki333tj1CSUisai5Cswsg9wcLNaPzsTHDswp4Az8" crossorigin="anonymous" fetchpriority="high"></script><script src="https://s4.zstatic.net/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous" fetchpriority="high"></script><script src="/js/siteInit.js?v=0.4.11" type="module" fetchpriority="high" defer=""></script></body></html>